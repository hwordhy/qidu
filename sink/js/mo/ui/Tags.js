define(["kernel","plugins/jquery.inputDefault","jui"],function(t){var e=t.Class.extend({init:function(t){var e=this;this.options=t=$.extend({input:"",ul:"",className:"",max:1e3,textMinlength:1,textMaxlength:100,disableEnter:!1,onAdd:$.noop,onRemove:$.noop,onOver:$.noop,onRendered:$.noop,onError:$.noop,onEmpty:$.noop,addAccordingTo:function(){return!0},defaultText:"输入标签",same:!1},t),this.number=0,this.enableAdd=!0,this.input=$(t.input),this.ul=$(t.ul),this.hidden=$('<input type="hidden" name='+(this.input.attr("name")||"tags")+" />"),this.input.after(this.hidden).attr("name",""),this.input.bind("keydown blur",function(n){var i=($(this),e.ul),o=$.trim(this.value);if(t.disableEnter){if(8!=n.keyCode)return!1;e.remove(n)}else if(e.number<=e.options.max&&""!=o&&!o.match(/[' '|\u3000]+/)){if("blur"==n.type&&e.enableAdd||"keydown"==n.type&&(9==n.keyCode||32==n.keyCode)||13==n.keyCode)return o.length>=e.options.textMinlength&&o.length<=e.options.textMaxlength?(e.add(o),this.value=""):e.options.onError.call(e,"lengthError"),!1}else e.number>0&&""==this.value&&8==n.keyCode&&i.find("li").size()&&e.remove(n)}),this.setValue(this.input.val()),this.input.parent().click(function(){e.input.focus()}).end(),this.ul.delegate("li .rm","click",function(t){e.remove(t)}),this.options.onRendered.call(this)},add:function(t,e){var n=this,i=n.options,o=i.className,r=n.ul,e=e||{},s=this.search(t);if(n.number>=i.max)return i.onOver(n),!1;if(!i.same&&s[0]===!0||!i.addAccordingTo(t))return s[2].find("a").effect("highlight"),!1;n.number++;var a=$('<li class="'+o+'"><a><em title="'+t+'" class="name">'+t+'</em><span title="删除" class="rm"></span></a></li>').data(e);return r.append(a),n.options.onAdd(n,a),n.hidden.val(n.getAll().join(" ")),n},addMore:function(t){var e=this;t="string"==typeof t?$.trim(t).split(" "):t,void 0!=t&&""!=t[0]&&$.map(t,function(t,n){e.add(t)})},remove:function(t){var e,n=this,o=n.ul;if(0==n.number)return opt.onEmpty(n),!1;switch(typeof t){case"object":switch(t.type){case"click":e=$(t.target).parent().parent();break;case"keydown":e=o.find("li:last")}break;case"number":e=o.find("li").eq(i);break;case"string":e=n.search(t)[2]}return e.length&&e.remove(),n.options.onRemove(n,e),n.hidden.val(n.getAll().join(" ")),n.number>0&&n.number--,n},empty:function(){this.ul.empty(),this.hidden.val(""),this.options.onEmpty(this)},search:function(t){for(var e=this.getAll(),n=[!1,0,null],i=0;i<e.length;i++)if(t==e[i]){n=[!0,i,this.ul.find("li").eq(i)];break}return n},getNumber:function(){return this.number},isMax:function(){return this.number>=this.options.max},getAll:function(){return $.map(this.ul.find("li"),function(t){return $(t).text()})},focus:function(){this.input.focus()},setValue:function(t){var e=this;this.value="string"==typeof t?$.trim(t).split(" "):t,""!=this.value[0]&&(this.input.val(""),$.each(this.value,function(t,n){e.add(n)}))},getValue:function(){return this.hidden.val()}});return e});